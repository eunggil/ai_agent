services:
  # AI Agent 애플리케이션
  ai-agent:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: ai-agent-dev
    ports:
      - "8000:8000"
    environment:
      - ENVIRONMENT=development
      - GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json
      - GCP_PROJECT_ID=${GCP_PROJECT_ID}
      - GCP_REGION=${GCP_REGION:-asia-northeast3}
      # AI 프로바이더 설정 (vertex | local)
      - AI_PROVIDER=${AI_PROVIDER:-vertex}
      # 옵션 2 (로컬 LLM): AI_PROVIDER=local 일 때 사용
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://ollama:11434}
      - LOCAL_MODEL=${LOCAL_MODEL:-llama3}
      # Vertex AI 모델 설정 (AI_PROVIDER=vertex 일 때)
      - VERTEX_AI_MODEL=${VERTEX_AI_MODEL:-gemini-2.0-flash}
      - VERTEX_AI_LOCATION=${VERTEX_AI_LOCATION:-us-central1}
      - USE_MOCK_GRAPH_DB=${USE_MOCK_GRAPH_DB:-true}
      # PostgreSQL 연결
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-ai_agent}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      # Redis 연결 (선택적)
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # 미디어 생성 설정
      - MEDIA_PROVIDER=${MEDIA_PROVIDER:-none}
      - MEDIA_TYPE=${MEDIA_TYPE:-image}
      - IMAGE_MODEL=${IMAGE_MODEL:-lcm-lora-sdxl}
      - VIDEO_MODEL=${VIDEO_MODEL:-animatediff-lcm}
      - DIFFUSERS_DEVICE=${DIFFUSERS_DEVICE:-auto}
      - MEDIA_OUTPUT_DIR=/app/generated_media
      - REPLICATE_API_TOKEN=${REPLICATE_API_TOKEN:-}
      # 미디어 GCS 버킷 (이미지/영상 public URL 반환용)
      - GCS_MEDIA_BUCKET=${GCS_MEDIA_BUCKET:-}
      # Vertex AI Imagen / Veo 설정
      - VERTEX_AI_IMAGEN_MODEL=${VERTEX_AI_IMAGEN_MODEL:-imagen-4.0-fast-generate-001}
      - VERTEX_VEO_MODEL=${VERTEX_VEO_MODEL:-veo-3.1-fast-generate-001}
      - VERTEX_VEO_GCS_BUCKET=${VERTEX_VEO_GCS_BUCKET:-}
      - VEO_TIMEOUT_SECONDS=${VEO_TIMEOUT_SECONDS:-600}
      # Imagen 4 / Veo는 us-central1 전용 (GCP_REGION과 별도 관리)
      - VERTEX_AI_MEDIA_LOCATION=${VERTEX_AI_MEDIA_LOCATION:-us-central1}
      # Langfuse 트레이싱 (profile: langfuse 실행 시)
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-sk-lf-local}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-pk-lf-local}
      - LANGFUSE_HOST=${LANGFUSE_HOST:-http://langfuse-web:3000}
    volumes:
      # 코드 hot reload를 위한 볼륨 마운트
      - ./src:/app/src
      - ./tests:/app/tests
      - ./scripts:/app/scripts
      # GCP 인증 키 마운트
      # - Vertex AI 사용 시: GOOGLE_APPLICATION_CREDENTIALS에 절대경로 지정
      # - Ollama(로컬) 사용 시: placeholder 파일 사용 (GCP 인증 불필요)
      - ${GOOGLE_APPLICATION_CREDENTIALS:-./credentials.placeholder.json}:/app/credentials.json:ro
      # 생성된 미디어 파일 저장 (로컬 디렉토리 바인딩 - Docker 재시작 후에도 유지)
      - ./generated_media:/app/generated_media
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - ai-agent-network

  # PostgreSQL (pgvector 포함) - 선택적
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ai-agent-postgres
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ai_agent}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql
      - ./scripts/pg_hba.conf:/etc/postgresql/pg_hba.conf
    command: postgres -c hba_file=/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-agent-network

  # Redis - 선택적 (캐시, LangGraph checkpointer)
  redis:
    image: redis:7-alpine
    container_name: ai-agent-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - ai-agent-network

  # Ollama (선택적) - 로컬 LLM 서버
  # 사용법: AI_PROVIDER=local docker-compose --profile local-llm up
  # 모델 다운로드: docker-compose exec ollama ollama pull llama3
  ollama:
    image: ollama/ollama:latest
    container_name: ai-agent-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - ai-agent-network
    profiles:
      - local-llm

  # ═══════════════════════════════════════════════════
  # Langfuse (LLM 트레이싱/모니터링)
  # 실행: docker-compose --profile langfuse up -d
  # 대시보드: http://localhost:3000  (admin@localhost / admin)
  # ═══════════════════════════════════════════════════
  langfuse-web:
    image: langfuse/langfuse:3
    container_name: ai-agent-langfuse-web
    profiles: ["langfuse"]
    restart: unless-stopped
    depends_on:
      langfuse-postgres:
        condition: service_healthy
      langfuse-redis:
        condition: service_healthy
      langfuse-clickhouse:
        condition: service_healthy
      langfuse-minio:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment: &langfuse-env
      DATABASE_URL: postgresql://postgres:postgres@langfuse-postgres:5432/langfuse
      NEXTAUTH_URL: ${LANGFUSE_NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${LANGFUSE_NEXTAUTH_SECRET:-mysecret}
      SALT: ${LANGFUSE_SALT:-mysalt}
      ENCRYPTION_KEY: ${LANGFUSE_ENCRYPTION_KEY:-0000000000000000000000000000000000000000000000000000000000000000}
      TELEMETRY_ENABLED: "false"
      CLICKHOUSE_MIGRATION_URL: clickhouse://langfuse-clickhouse:9000
      CLICKHOUSE_URL: http://langfuse-clickhouse:8123
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
      CLICKHOUSE_CLUSTER_ENABLED: "false"
      REDIS_HOST: langfuse-redis
      REDIS_PORT: 6379
      REDIS_AUTH: langfuse
      LANGFUSE_S3_EVENT_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_EVENT_UPLOAD_REGION: auto
      LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: http://langfuse-minio:9000
      LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: "true"
      LANGFUSE_S3_EVENT_UPLOAD_PREFIX: events/
      LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: langfuse
      LANGFUSE_S3_MEDIA_UPLOAD_REGION: auto
      LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: minio
      LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: miniosecret
      LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: http://localhost:9090
      LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: "true"
      LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: media/
      # 초기 계정/프로젝트 자동 생성 (첫 실행 시)
      LANGFUSE_INIT_ORG_ID: local-org
      LANGFUSE_INIT_ORG_NAME: Local
      LANGFUSE_INIT_PROJECT_ID: ai-agent-project
      LANGFUSE_INIT_PROJECT_NAME: ai-agent
      LANGFUSE_INIT_PROJECT_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-pk-lf-local}
      LANGFUSE_INIT_PROJECT_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-sk-lf-local}
      LANGFUSE_INIT_USER_EMAIL: ${LANGFUSE_INIT_USER_EMAIL:-admin@local.dev}
      LANGFUSE_INIT_USER_NAME: ${LANGFUSE_INIT_USER_NAME:-admin}
      LANGFUSE_INIT_USER_PASSWORD: ${LANGFUSE_INIT_USER_PASSWORD:-admin}
    networks:
      - ai-agent-network

  langfuse-worker:
    image: langfuse/langfuse-worker:3
    container_name: ai-agent-langfuse-worker
    profiles: ["langfuse"]
    restart: unless-stopped
    depends_on:
      langfuse-postgres:
        condition: service_healthy
      langfuse-redis:
        condition: service_healthy
      langfuse-clickhouse:
        condition: service_healthy
      langfuse-minio:
        condition: service_healthy
    environment:
      <<: *langfuse-env
    networks:
      - ai-agent-network

  langfuse-postgres:
    image: postgres:16
    container_name: ai-agent-langfuse-postgres
    profiles: ["langfuse"]
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: langfuse
    volumes:
      - langfuse_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - ai-agent-network

  langfuse-redis:
    image: redis:7-alpine
    container_name: ai-agent-langfuse-redis
    profiles: ["langfuse"]
    restart: unless-stopped
    command: redis-server --requirepass langfuse
    volumes:
      - langfuse_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "langfuse", "ping"]
      interval: 3s
      timeout: 5s
      retries: 10
    networks:
      - ai-agent-network

  langfuse-clickhouse:
    image: clickhouse/clickhouse-server
    container_name: ai-agent-langfuse-clickhouse
    profiles: ["langfuse"]
    restart: unless-stopped
    user: "101:101"
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
    volumes:
      - langfuse_clickhouse_data:/var/lib/clickhouse
      - langfuse_clickhouse_logs:/var/log/clickhouse-server
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - ai-agent-network

  langfuse-minio:
    image: cgr.dev/chainguard/minio
    container_name: ai-agent-langfuse-minio
    profiles: ["langfuse"]
    restart: unless-stopped
    entrypoint: sh
    command: -c 'mkdir -p /data/langfuse && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: miniosecret
    ports:
      - "9090:9000"
    volumes:
      - langfuse_minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 1s
      timeout: 5s
      retries: 10
    networks:
      - ai-agent-network

  # pgAdmin (선택적) - PostgreSQL 관리 UI
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ai-agent-pgadmin
    ports:
      - "5050:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=admin
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - ai-agent-network
    profiles:
      - tools

networks:
  ai-agent-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  pgadmin_data:
  ollama_data:
  langfuse_postgres_data:
  langfuse_redis_data:
  langfuse_clickhouse_data:
  langfuse_clickhouse_logs:
  langfuse_minio_data:
